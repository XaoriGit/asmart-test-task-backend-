name: Ð”ÐµÐ¿Ð»Ð¾Ð¹
on:
  pull_request:
    types:
     - synchronized
    branches:
      - master
  push:
    branches:
     - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Ð¢Ð°Ñ‰Ð¸Ð¼ ÐºÐ»ÑŽÑ‡Ð¸Ðº
        run: |
          echo "${{ secrets.SSH_KEY }}" > deploy_key.pem
          chmod 600 deploy_key.pem

      - name: Deploy to server via SSH
        run: |
          ssh -i deploy_key.pem -p ${{ secrets.PORT }} -o StrictHostKeyChecking=no ${{ secrets.USER }}@${{ secrets.HOST }} << 'EOF'
            set -e
            cd /srv/asmart-task-test/
            echo "ðŸ§  ÐŸÑƒÐ»Ð¸Ð¼ÑÑ Ñ Ð³Ð¸Ñ‚Ð°..."
            git checkout master
            git pull origin master

            echo "ðŸ”„ Ð Ð¾Ð½ÑÐµÐ¼ ÑÐµÑ€Ð²Ð¸ÑÑ‹..."
            docker compose down
            docker compose up -d --build

            echo "âœ… Ð¡ÐµÑ€Ð²Ð¸ÑÑ‹ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹. Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹"
          EOF
